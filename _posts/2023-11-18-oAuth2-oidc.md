---
title: Integrate oAuth2 and OpenIDConnect with C#.Net API and Azure APIM
date: 2023-11-18 12:00 -500
categories: [Architecture,Azure,APIM,oAuth2,OIDC,C#.Net]
tags: [api-management, oauth2, azure, api, c#]
author: gowda
---

## Introduction

This blog describe how to secure APIs with APIM and oAuth and OIDC.

### Prerequisites

1. Azure API Management: To protect Azure FunctionApp. public access to Azure function endpoint is restricted. Can be called only from APIM.
2. Azure EntraID: To register APIM backend and client app, in this case Postman.
3. Azure FunctionApp: Simple Httptrigger with Get endpoint that returns a simple message.
4. Postman: To test 

## Architecture

![Desktop View](/assets/img/oauth/oauth2-oidc-azentraid.png)

1. Postman is a client app in this case. It requests a JWT access token from Azure Entra ID using app registration client id and client secret. This is OIDC.
2. Azure Entra returns JWT access token.
3. Postman makes a request to APIM endpoint with Bearer token in the Authorization header.
4. APIM validates the token with Azure Entra ID.
5. APIM returns success payload or 401 unauthorization error.

In your scenario, you are using OIDC to authenticate the user/application and obtain a JWT token. You are then using OAuth 2.0 to authorize the client to access the protected resource, which is the API via APIM.

## Different oAuth Grant types

![Desktop View](/assets/img/oauth/grant-flows.png)

### Description of Grant types

![Desktop View](/assets/img/oauth/grant-types.png)

## High level steps required to configure oAuth in Azure Entra

#### Register an app: oauth-apim-backend in Azure Entra to represent the protected APIM resource.
![Desktop View](/assets/img/oauth/entraapp1-1.png)

![Desktop View](/assets/img/oauth/entraapp1-2.png)

![Desktop View](/assets/img/oauth/entraapp1-3.png)

#### Register another application client-app: oauth-client-app in Azure Entra which represent postman that wants to access the protected APIM resource.​
![Desktop View](/assets/img/oauth/entraapp2-1.png)

<!-- ![Desktop View](/assets/img/oauth/entraapp2-2.png) -->

### Configure API management as shown below.
To protect this API using OAuth, go to the “Design” section of the API in APIM and in the “Inbound Policy” block, add the following policy:
```javascript
        <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Access token is missing or invalid.">
            <openid-config url="https://login.microsoftonline.com/2a109937-e9f4-4867-b038-474c0f209966/v2.0/.well-known/openid-configuration" />
            <audiences>
                <audience>api://6bfb37d3-0969-4d30-b165-eb939207071b</audience>
                <audience>6bfb37d3-0969-4d30-b165-eb939207071b</audience>
            </audiences>
            <issuers>
                <issuer>https://sts.windows.net/2a109937-e9f4-4867-b038-474c0f209966/</issuer>
            </issuers>
            <required-claims>
                <claim name="roles" match="any">
                    <value>API.Read</value>
                </claim>
            </required-claims>
        </validate-jwt>

```

#### In postman, test the oAuth, OIDC and APIM integration.